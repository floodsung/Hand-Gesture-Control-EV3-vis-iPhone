<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T2U3">labels</span> = cnnPredict(<span class="var type1" id="S3T1U6">images</span>,<span class="var type1" id="S4T6U7">opttheta</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%addpath ./opt_parameters;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%addpath ./data;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">%load('opttheta_8epoches_cnn.mat');</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line"><span class="comment">%images = imread(img);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%images = img;</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line"><span class="mxinfo " id="T2:U4"><span class="var type1" id="S5T2U10">imageDim</span> = <span class="mxinfo " id="T2:U6">96</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line"><span class="mxinfo " id="T2:U7"><span class="var type1" id="S6T2U14">numClasses</span> = <span class="mxinfo " id="T2:U9">5</span></span>;  <span class="comment">% Number of classes (MNIST images fall into 10 classes)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line"><span class="mxinfo " id="T2:U10"><span class="var type1" id="S7T2U18">filterDim</span> = <span class="mxinfo " id="T2:U12">9</span></span>;    <span class="comment">% Filter size for conv layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line"><span class="mxinfo " id="T2:U13"><span class="var type1" id="S8T2U22">numFilters</span> = <span class="mxinfo " id="T2:U15">20</span></span>;   <span class="comment">% Number of filters for conv layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line"><span class="mxinfo " id="T2:U16"><span class="var type1" id="S9T2U26">poolDim</span> = <span class="mxinfo " id="T2:U18">2</span></span>;      <span class="comment">% Pooling dimension, (should divide imageDim-filterDim+1)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line"><span class="mxinfo " id="T2:U19"><span class="var type1" id="S5T2U30">imageDim</span> = <span class="mxinfo " id="T2:U21">size(<span class="var type1" id="S3T1U33">images</span>,1)</span></span>; <span class="comment">% height/width of image</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line"><span class="mxinfo " id="T2:U23"><span class="var type1" id="S11T2U37">numImages</span> = <span class="mxinfo " id="T2:U25">size(<span class="var type1" id="S3T1U40">images</span>,3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line"><span class="mxinfo " id="T2:U27"><span class="var type1" id="S12T2U44">lamda</span> = <span class="mxinfo " id="T2:U29">0</span></span>; <span class="comment">% weight decay parameter</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line"><span class="mxinfo " id="T2:U30"><span class="var type1" id="S13T2U48">convDim</span> = <span class="mxinfo " id="T2:U32"><span class="var type1" id="S5T2U51">imageDim</span>-<span class="var type1" id="S7T2U52">filterDim</span>+1</span></span>; <span class="comment">% dimension of convolved output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line"><span class="mxinfo " id="T2:U35"><span class="var type1" id="S14T2U56">outputDim</span> = <span class="mxinfo " id="T2:U37">(<span class="var type1" id="S13T2U59">convDim</span>)/<span class="var type1" id="S9T2U60">poolDim</span></span></span>; <span class="comment">% dimension of subsampled output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">[<span class="mxinfo " id="T20:U40"><span class="var type1" id="S15T20U64">Wc</span></span>, <span class="mxinfo " id="T23:U42"><span class="var type1" id="S16T23U65">Wd</span></span>, <span class="mxinfo " id="T25:U44"><span class="var type1" id="S17T25U66">bc</span></span>, <span class="mxinfo " id="T24:U46"><span class="var type1" id="S18T24U67">bd</span></span>] = <span class="fcn" id="F83N3:B69">cnnParamsToStack</span>(<span class="var type1" id="S4T6U70">opttheta</span>,<span class="var type1" id="S5T2U71">imageDim</span>,<span class="var type1" id="S7T2U72">filterDim</span>,<span class="var type1" id="S8T2U73">numFilters</span>,<span class="keyword">...</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">                        <span class="var type1" id="S9T2U74">poolDim</span>,<span class="var type1" id="S6T2U75">numClasses</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line"><span class="comment">% convDim x convDim x numFilters x numImages tensor for storing activations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line"><span class="mxinfo " id="T41:U54"><span class="var type1" id="S20T41U78">activations</span> = <span class="mxinfo " id="T41:U56">zeros(<span class="mxinfo " id="T2:U57"><span class="var type1" id="S13T2U81">convDim</span></span>,<span class="mxinfo " id="T2:U59"><span class="var type1" id="S13T2U82">convDim</span></span>,<span class="mxinfo " id="T2:U61"><span class="var type1" id="S8T2U83">numFilters</span></span>,<span class="var type1" id="S11T2U84">numImages</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line"><span class="comment">% outputDim x outputDim x numFilters x numImages tensor for storing</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"><span class="comment">% subsampled activations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line"><span class="mxinfo " id="T45:U64"><span class="var type1" id="S22T45U87">activationsPooled</span> = <span class="mxinfo " id="T45:U66">zeros(<span class="mxinfo " id="T2:U67"><span class="var type1" id="S14T2U90">outputDim</span></span>,<span class="mxinfo " id="T2:U69"><span class="var type1" id="S14T2U91">outputDim</span></span>,<span class="mxinfo " id="T2:U71"><span class="var type1" id="S8T2U92">numFilters</span></span>,<span class="var type1" id="S11T2U93">numImages</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line"><span class="mxinfo " id="T41:U74"><span class="var type1" id="S20T41U96">activations</span> = <span class="mxinfo " id="T41:U76"><span class="fcn" id="F251N2:B98">cnnConvolve</span>(<span class="var type1" id="S7T2U99">filterDim</span>,<span class="var type1" id="S8T2U100">numFilters</span>,<span class="var type1" id="S3T1U101">images</span>,<span class="var type1" id="S15T20U102">Wc</span>,<span class="var type1" id="S17T25U103">bc</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line"><span class="mxinfo " id="T45:U82"><span class="var type1" id="S22T45U106">activationsPooled</span> = <span class="mxinfo " id="T45:U84"><span class="fcn" id="F285N4:B108">cnnPool</span>(<span class="var type1" id="S9T2U109">poolDim</span>,<span class="var type1" id="S20T41U110">activations</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line"><span class="comment">% Reshape activations into 2-d matrix, hiddenSize x numImages,</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line"><span class="comment">% for Softmax layer</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line"><span class="mxinfo " id="T46:U87"><span class="var type1" id="S22T46U113">activationsPooled</span> = <span class="mxinfo " id="T46:U89">reshape(<span class="var type1" id="S22T45U116">activationsPooled</span>,[],<span class="var type1" id="S11T2U119">numImages</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line"><span class="mxinfo " id="T24:U92"><span class="var type1" id="S26T24U122">probs</span> = <span class="mxinfo " id="T24:U94">zeros(<span class="mxinfo " id="T2:U95"><span class="var type1" id="S6T2U125">numClasses</span></span>,<span class="var type1" id="S11T2U126">numImages</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line"><span class="mxinfo " id="T24:U98"><span class="var type1" id="S27T24U129">temp_probs</span> = <span class="mxinfo " id="T24:U100"><span class="mxinfo " id="T24:U101"><span class="var type1" id="S16T23U132">Wd</span>*<span class="var type1" id="S22T46U133">activationsPooled</span></span> + <span class="mxinfo " id="T24:U104">repmat(<span class="var type1" id="S18T24U136">bd</span>,1,<span class="var type1" id="S11T2U138">numImages</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line"><span class="mxinfo " id="T24:U107"><span class="var type1" id="S27T24U141">temp_probs</span> = <span class="mxinfo " id="T24:U109">exp(<span class="var type1" id="S27T24U144">temp_probs</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line"><span class="mxinfo " id="T24:U111"><span class="var type1" id="S26T24U147">probs</span> = <span class="mxinfo " id="T24:U113">bsxfun(@rdivide,<span class="var type1" id="S27T24U152">temp_probs</span>,<span class="mxinfo " id="T2:U115">sum(<span class="var type1" id="S27T24U155">temp_probs</span>)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">[<span class="mxinfo " id="T2:U117"><span class="mxinfo " id="T2:U118">~</span></span>,<span class="mxinfo " id="T2:U119"><span class="var type1" id="S2T2U160">labels</span></span>] = max(<span class="var type1" id="S26T24U163">probs</span>,[],1);</span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line"><span class="comment">%fprintf('CNN Predicted class is %d\n',labels);</span></span></span>
</pre>
